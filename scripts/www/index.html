<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>åˆ‡æ°§å‚æ•°è®¡ç®—å™¨ Pro (æ»šåŠ¨ç‰ˆ)</title>
	<style>
		:root {
			--primary: #3498db;
			--success: #2ecc71;
			--warning: #f39c12;
			--danger: #e74c3c;
			--bg: #f5f7fa;
			--card: #ffffff;
			--dark-blue: #2c3e50;
		}

		* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
		body { background-color: var(--bg); font-family: -apple-system, sans-serif; /* ç§»é™¤ padding-bottom */ }

		.header { background: var(--dark-blue); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
		.header h1 { font-size: 1.1rem; letter-spacing: 1px; }

		.container { padding: 12px; max-width: 600px; margin: 0 auto; }

		/* é…ç½®æŠ˜å  */
		details { background: var(--card); border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
		summary { padding: 12px; font-size: 0.9rem; font-weight: bold; color: var(--primary); list-style: none; display: flex; justify-content: space-between; cursor: pointer; }
		summary::after { content: "â–¼"; font-size: 0.7rem; color: #999; }
		details[open] summary::after { content: "â–²"; }
		.config-grid { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; border-top: 1px solid #f0f0f0; }
		.config-item { position: relative; }
		.config-item label { display: block; font-size: 0.7rem; color: #7f8c8d; margin-bottom: 3px; line-height: 1.2; }
		.config-item input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; }

		/* æ•°æ®å¡ç‰‡ */
		.data-card { background: var(--card); border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); position: relative; }
		.data-card.manual-mode { border-left-color: var(--warning); }
		
		.card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
		.mode-btn { padding: 5px 12px; border-radius: 20px; border: none; font-size: 0.75rem; font-weight: bold; color: white; cursor: pointer; }
		.mode-auto { background: var(--primary); }
		.mode-manual { background: var(--warning); }
		.warning-tag { position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: bold; display: none; }

		.grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
		.field label { display: block; font-size: 0.75rem; color: #95a5a6; margin-bottom: 4px; }
		.edit-input { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 1rem; font-weight: bold; background: #fafafa; }
		.edit-input:disabled { opacity: 0.4; }
		.edit-input.warn { border-color: var(--warning); }
		
		.val { font-size: 1.1rem; font-weight: 800; color: #2d3436; font-family: 'Courier New', Courier, monospace; }
		.res-highlight { color: var(--primary); }
		.res-success { color: var(--success); }
		.res-steam { color: #9b59b6; }
		.res-total { color: #d35400; }
		.res-err { color: var(--danger) !important; font-size: 0.85rem !important; }

		/* Toast æç¤º - ä¿®æ”¹ä¸ºå›ºå®šåœ¨å±å¹•åº•éƒ¨é™„è¿‘ï¼Œä¸å—æ»šåŠ¨å½±å“ */
		#toast {
			position: fixed;
			bottom: 40px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 10px 20px;
			border-radius: 25px;
			font-size: 0.85rem;
			z-index: 2000;
			display: none;
			white-space: nowrap;
			box-shadow: 0 4px 15px rgba(0,0,0,0.2);
		}

		/* åº•éƒ¨æ“ä½œåŒº - ä¿®æ”¹ä¸ºéšé¡µé¢æ»šåŠ¨ï¼Œå¹¶å¯¹é½å®¹å™¨ */
		.bottom-bar { 
			max-width: 600px;
			margin: 20px auto 40px; /* ä¸Šè¾¹è·20pxï¼Œåº•éƒ¨ç•™40pxç©ºç™½ */
			padding: 0 12px;
			display: flex; 
			flex-direction: column; 
			gap: 12px; 
			z-index: 99; 
		}
		.btn-group { display: flex; gap: 8px; width: 100%; flex-wrap: wrap; }
		.btn { flex: 1; min-width: 80px; padding: 12px 5px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
		.btn-calc { background: var(--primary); flex: 1.5; font-size: 1rem; }
		.btn-add { background: var(--success); }
		.btn-reset { background: #95a5a6; }

		.footer-info { text-align: center; color: #7f8c8d; font-size: 0.75rem; line-height: 1.4; padding-top: 15px; border-top: 1px solid #ddd; margin-top: 10px; }

		@keyframes flash {
			0% { opacity: 0.5; }
			100% { opacity: 1; }
		}
		.flash-active { animation: flash 0.3s ease-out; }
	</style>
</head>
<body>

	<div class="header"><h1>åˆ‡æ°§å‚æ•°è®¡ç®—å™¨</h1></div>
	<div id="toast">æç¤ºå­—</div>

	<div class="container">
		<details open>
			<summary>âš™ï¸ æ ¸å¿ƒå‚æ•°è®¾ç½®</summary>
			<div class="config-grid">
				<div class="config-item"><label>é£é‡ç³»æ•°(NmÂ³/Hz)</label><input type="number" id="windPerHz" value="378" oninput="saveConfig()"></div>
				<div class="config-item"><label>åŠ ç…¤ç³»æ•°(kg/Hz)</label><input type="number" id="coalPerHz" value="1300" oninput="saveConfig()"></div>
				<div class="config-item"><label>åŠ ç…¤K1</label><input type="number" id="coalK1" value="1.05" step="0.01" oninput="saveConfig()"></div>
				<div class="config-item"><label>åŠ ç…¤K2</label><input type="number" id="coalK2" value="0.0017" step="0.0001" oninput="saveConfig()"></div>
				<div class="config-item"><label>åŠ ç…¤K3</label><input type="number" id="coalK3" value="3.23" step="0.01" oninput="saveConfig()"></div>
				<div class="config-item"><label>è’¸æ±½å¯†åº¦(kg/NmÂ³)</label><input type="number" id="steamRho" value="0.804" step="0.001" oninput="saveConfig()"></div>
				<div class="config-item"><label>çº¯æ°§æµé‡(é£æœº0Hzæ—¶è¡¥æ°§é¢„ä¼°å€¼)</label><input type="number" id="pureO2Flow" value="10325" oninput="saveConfig()"></div>
			</div>
		</details>

		<div id="cardContainer"></div>
	</div>

	<div class="bottom-bar">
		<div class="btn-group">
			<button class="btn btn-add" id="addAuto">ï¼‹è‡ªåŠ¨</button>
			<button class="btn btn-add" id="addManual" style="background:var(--warning)">ï¼‹æ‰‹åŠ¨</button>
			<button class="btn btn-calc" id="calcBtn">âš¡ ç«‹å³è®¡ç®—</button>
			<button class="btn btn-reset" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
		</div>
		<div class="footer-info">
			è®¡ç®—æ•°æ®ä»…ä¾›å‚è€ƒ<br>åˆ¶ä½œäººï¼šåˆ˜é£
		</div>
	</div>

	<script>
		// [ä¿æŒåŸæœ‰è„šæœ¬é€»è¾‘ä¸å˜...]
		const STORAGE_KEY_DATA = 'oxyCalc_tableData';
		const STORAGE_KEY_CONFIG = 'oxyCalc_config';
		
		let tableData = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || [
			{ fan: 60, o2: 21, steamRatio: 0.3, mode: 'auto', manualAddO2: 1500, manualTotalWind: 10000, manualO2Ratio: 18.0, manualSteam: 1000, manualFanHz: 0 }
		];

		document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('addAuto').onclick = () => addRow('auto');
			document.getElementById('addManual').onclick = () => addRow('manual');
			document.getElementById('calcBtn').onclick = calcAll;
			document.getElementById('clearBtn').onclick = clearAllData;
			initPage();
		});

		function showToast(msg) {
			const toast = document.getElementById('toast');
			toast.innerText = msg;
			toast.style.display = 'block';
			setTimeout(() => { toast.style.display = 'none'; }, 2000);
		}

		function initPage() {
			const cfg = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG));
			if(cfg) {
				document.getElementById('windPerHz').value = cfg.windPerHz || 378;
				document.getElementById('coalPerHz').value = cfg.coalPerHz || 1300;
				document.getElementById('coalK1').value = cfg.coalK1 || 1.05;
				document.getElementById('coalK2').value = cfg.coalK2 || 0.0017;
				document.getElementById('coalK3').value = cfg.coalK3 || 3.23;
				document.getElementById('steamRho').value = cfg.steamRho || 0.804;
				document.getElementById('pureO2Flow').value = cfg.pureO2Flow || 10325;
			}
			renderCards();
		}

		function saveConfig() {
			const config = {
				windPerHz: Number(document.getElementById('windPerHz').value) || 378,
				coalPerHz: Number(document.getElementById('coalPerHz').value) || 1300,
				coalK1: Number(document.getElementById('coalK1').value) || 1.05,
				coalK2: Number(document.getElementById('coalK2').value) || 0.0017,
				coalK3: Number(document.getElementById('coalK3').value) || 3.23,
				steamRho: Number(document.getElementById('steamRho').value) || 0.804,
				pureO2Flow: Number(document.getElementById('pureO2Flow').value) || 10325
			};
			localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
			performCalculation(false);
		}

		function renderCards() {
			const container = document.getElementById('cardContainer');
			if(!container) return;
			container.innerHTML = '';
			tableData.forEach((item, index) => {
				const isManual = item.mode === 'manual';
				const card = document.createElement('div');
				card.className = `data-card ${isManual ? 'manual-mode' : ''}`;
				if (!isManual) {
					card.innerHTML = `
						<div class="card-header">
							<button class="mode-btn mode-auto" onclick="toggleMode(${index})">æ¨¡å¼ï¼šè‡ªåŠ¨</button>
							<span style="font-size:1.2rem; color:#e74c3c; cursor:pointer;" onclick="delRow(${index})">ğŸ—‘ï¸</span>
						</div>
						<div class="grid-layout">
							<div class="field"><label>é£æœºé¢‘ç‡(Hz)</label><input type="number" class="edit-input" value="${item.fan || 60}" oninput="updateData(${index}, 'fan', this.value)"></div>
							<div class="field"><label>ç›®æ ‡æ°§æµ“åº¦(%)</label><input type="number" class="edit-input" value="${item.o2 || 21}" oninput="updateData(${index}, 'o2', this.value)"></div>
							<div class="field"><label>é£æœºé£é‡(mÂ³/h)</label><div class="val res-highlight" id="wind-${index}">-</div></div>
							<div class="field"><label>å…‘å…¥æ°§æ°”(mÂ³/h)</label><div class="val res-highlight" id="addO2-${index}">-</div></div>
							<div class="field"><label>åŠ ç…¤é¢‘ç‡(Hz)</label><div class="val res-success" id="coalFreq-${index}">-</div></div>
							<div class="field"><label>å®é™…åŠ ç…¤(kg/h)</label><div class="val res-success" id="coal-${index}">-</div></div>
							<div class="field"><label>è’¸æ±½æ¯”ä¾‹</label><input type="number" step="0.01" class="edit-input" value="${item.steamRatio || 0.3}" oninput="updateData(${index}, 'steamRatio', this.value)"></div>
							<div class="field"><label>è’¸æ±½é‡(kg/h)</label><div class="val res-steam" id="steam-${index}">-</div></div>
							<div class="field" style="grid-column: span 2; background: #fff9f0; padding: 10px; border-radius: 8px; margin-top: 5px;">
								<label style="color:#d35400; font-weight:bold;">ç‚‰å†…æ€»é£é‡ (mÂ³/h)</label>
								<div class="val res-total" id="totalWind-${index}" style="font-size:1.3rem">-</div>
							</div>
							<div class="field" style="grid-column: span 2; border-top: 1px solid #f0f0f0; padding-top: 8px;">
								<label>æ°§æ°”æ€»é…æ¯”%</label><div class="val" id="ratio-${index}" style="color:#e67e22; font-size:1.2rem">-</div>
							</div>
						</div>`;
				} else {
					card.innerHTML = `
						<div class="warning-tag" id="overWarn-${index}">âš ï¸ é£é‡åå·®å¤§</div>
						<div class="card-header">
							<button class="mode-btn mode-manual" onclick="toggleMode(${index})">æ‰‹åŠ¨åæ¨æ¨¡å¼</button>
							<span style="font-size:1.2rem; color:#e74c3c; cursor:pointer;" onclick="delRow(${index})">ğŸ—‘ï¸</span>
						</div>
						<div class="grid-layout">
							<div class="field"><label>å…‘æ°§é‡(NmÂ³/h)</label><input type="number" class="edit-input" value="${item.manualAddO2 || 1500}" oninput="updateData(${index}, 'manualAddO2', this.value)"></div>
							<div class="field"><label>ç›®æ ‡æ€»æ°§ç‡(%)</label><input type="number" class="edit-input" value="${item.manualO2Ratio || 18.0}" oninput="updateData(${index}, 'manualO2Ratio', this.value)"></div>
							<div class="field" style="grid-column: span 2;"><label style="color:var(--warning)">ç›®æ ‡æ€»é£é‡(NmÂ³/h)</label><input type="number" class="edit-input warn" value="${item.manualTotalWind || 10000}" oninput="updateData(${index}, 'manualTotalWind', this.value)"></div>
							<div class="field"><label>è’¸æ±½é‡(kg/h)</label><input type="number" class="edit-input" value="${item.manualSteam || 1000}" oninput="updateData(${index}, 'manualSteam', this.value)"></div>
							<div class="field"><label>é€‰å¡«:é£æœºé¢‘ç‡(Hz)</label><input type="number" class="edit-input" placeholder="è‡ªåŠ¨æ¨ç®—" value="${item.manualFanHz || ''}" oninput="updateData(${index}, 'manualFanHz', this.value)"></div>
							<div class="field"><label>è®¡ç®—é¢‘ç‡(Hz)</label><div class="val res-highlight" id="wind-${index}">-</div></div>
							<div class="field"><label>é£æœºé£é‡(NmÂ³/h)</label><div class="val" id="fanVol-${index}">-</div></div>
							<div class="field"><label>æ··åˆæ€»æ°§ç‡(%)</label><div class="val" style="color:#d35400" id="ratio-${index}">-</div></div>
							<div class="field"><label>å…‘å…¥æ°§æ°”(NmÂ³/h)</label><div class="val res-highlight" id="addO2-${index}">-</div></div>
							<div class="field"><label>è’¸æ±½æ¯”ä¾‹</label><input type="number" step="0.1" class="edit-input" style="height:32px;" value="${item.steamRatio || 0.3}" oninput="updateData(${index}, 'steamRatio', this.value)"></div>
							<div class="field"><label>è®¡ç®—åŠ ç…¤(kg/h)</label><div class="val res-success" id="coal-${index}">-</div></div>
							<div class="field"><label>åŠ ç…¤é¢‘ç‡(Hz)</label><div class="val res-success" id="coalFreq-${index}">-</div></div>
							<div class="field"><label>è®¡ç®—è’¸æ±½(kg/h)</label><div class="val res-steam" id="steam-${index}">-</div></div>
							<div class="field"><label>æ€»é£é‡(NmÂ³/h)</label><div class="val res-total" id="totalWind-${index}" style="font-weight:900;">-</div></div>
						</div>`;
				}
				container.appendChild(card);
			});
			performCalculation(false);
		}

		function updateData(index, field, val) {
			if(!tableData[index]) return;
			tableData[index][field] = Number(val) || 0;
			localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(tableData));
			performCalculation(false);
		}

		function toggleMode(index) {
			if(!tableData[index]) return;
			tableData[index].mode = tableData[index].mode === 'auto' ? 'manual' : 'auto';
			localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(tableData));
			showToast(`åˆ‡æ¢è‡³${tableData[index].mode === 'manual' ? 'æ‰‹åŠ¨åæ¨æ¨¡å¼' : 'è‡ªåŠ¨è®¡ç®—æ¨¡å¼'}`);
			renderCards();
		}

		function performCalculation(animate = true) {
			const cfgLocal = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)) || {};
			const cfg = {
				windPerHz: cfgLocal.windPerHz || 378,
				coalPerHz: cfgLocal.coalPerHz || 1300,
				coalK1: cfgLocal.coalK1 || 1.05,
				coalK2: cfgLocal.coalK2 || 0.0017,
				coalK3: cfgLocal.coalK3 || 3.23,
				steamRho: cfgLocal.steamRho || 0.804,
				pureO2: cfgLocal.pureO2Flow || 10325
			};

			tableData.forEach((item, index) => {
				const isManual = item.mode === 'manual';
				if (!isManual) {
					const fan = item.fan || 0;
					const wind = Math.round(fan * cfg.windPerHz);
					const windO2 = Math.round(wind * 0.21);
					let addO2 = 0, totalO2 = 0;
					if (fan === 0) { addO2 = cfg.pureO2; }
					else if (item.o2 > 21) { addO2 = Math.round((windO2 - wind * (item.o2/100)) / ((item.o2/100) - 1)); }
					totalO2 = windO2 + addO2;
					const totalGas = wind + addO2;
					const effO2 = item.o2 || 21;
					const coal = Math.round((cfg.coalK1 - cfg.coalK2 * effO2) * cfg.coalK3 * totalO2);
					const steam = Math.round(coal * (item.steamRatio || 0.3));
					const totalWindCalculated = Math.round(addO2 + (steam * 1.25) + wind);
					const totalRatio = (totalO2 / ((steam/cfg.steamRho) + totalGas) * 100).toFixed(2);
					const coalFreq = (coal / cfg.coalPerHz).toFixed(2);
					setVal(`wind-${index}`, wind.toLocaleString(), animate);
					setVal(`addO2-${index}`, addO2.toLocaleString(), animate);
					setVal(`coal-${index}`, coal.toLocaleString(), animate);
					setVal(`coalFreq-${index}`, coalFreq, animate);
					setVal(`steam-${index}`, steam.toLocaleString(), animate);
					setVal(`totalWind-${index}`, totalWindCalculated.toLocaleString(), animate);
					setVal(`ratio-${index}`, totalRatio + '%', animate);
				} else {
					let wind = 0, addO2 = item.manualAddO2 || 0, steam = item.manualSteam || 0, totalW = 0, fHz = 0, cHz = 0, calcO2 = 0, err = false;
					const targetW = item.manualTotalWind || 0;
					if(targetW <= 0) { err = true; } else {
						if (item.manualFanHz > 0) { fHz = item.manualFanHz; wind = fHz * cfg.windPerHz; } else { wind = targetW - addO2 - (steam / cfg.steamRho); fHz = wind / cfg.windPerHz; }
						totalW = wind + addO2 + (steam / cfg.steamRho);
						const totalO2Val = (wind * 0.21) + addO2;
						calcO2 = (totalO2Val / totalW) * 100;
						let coalVal = (cfg.coalK1 - cfg.coalK2 * (item.manualO2Ratio || 18)) * cfg.coalK3 * totalO2Val;
						cHz = coalVal / cfg.coalPerHz;
						steam = Math.round(coalVal * (item.steamRatio || 0.3));
						updateUI(`wind-${index}`, fHz, 2, err, animate);
						updateUI(`fanVol-${index}`, wind, 0, err, animate);
						updateUI(`ratio-${index}`, calcO2, 1, err, animate);
						updateUI(`addO2-${index}`, addO2, 0, err, animate);
						updateUI(`coal-${index}`, coalVal, 0, err, animate);
						updateUI(`coalFreq-${index}`, cHz, 2, err, animate);
						updateUI(`steam-${index}`, steam, 0, err, animate);
						updateUI(`totalWind-${index}`, totalW, 0, err, animate, item.manualTotalWind);
					}
					const warnTag = document.getElementById(`overWarn-${index}`);
					if(warnTag) warnTag.style.display = (!err && Math.abs(totalW - (item.manualTotalWind || 0))>100) ? 'block' : 'none';
				}
			});
		}

		function updateUI(id, val, fix, err, animate, target) {
			const el = document.getElementById(id);
			if(!el) return;
			if(err || isNaN(val) || val < -0.1) { el.innerText = "æ•°æ®çŸ›ç›¾"; el.className = "val res-err"; } 
			else {
				el.innerText = fix === 2 ? val.toFixed(2) : (fix === 1 ? val.toFixed(1) : Math.round(val).toLocaleString());
				el.className = el.className.replace('res-err', '');
				if(target && Math.abs(val - target) > 100) el.style.color = 'var(--danger)'; else el.style.color = '';
				if(animate) addFlash(el);
			}
		}

		function setVal(id, val, animate) {
			const el = document.getElementById(id);
			if(el) { el.innerText = val; if(animate) addFlash(el); }
		}

		function addFlash(el) {
			el.classList.remove('flash-active');
			void el.offsetWidth;
			el.classList.add('flash-active');
		}

		function calcAll() { performCalculation(true); showToast("âœ… è®¡ç®—å®Œæˆ"); }

		function addRow(mode) {
			const lastSameModeItem = tableData.filter(item => item.mode === mode).pop();
			const newItem = lastSameModeItem ? { ...lastSameModeItem } : { fan: 60, o2: 21, steamRatio: 0.3, manualAddO2: 1500, manualTotalWind: 10000, manualO2Ratio: 18.0, manualSteam: 1000, manualFanHz: 0 };
			newItem.mode = mode;
			tableData.push(newItem);
			localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(tableData));
			renderCards();
			showToast(`â• å·²æ·»åŠ ${mode==='auto'?'è‡ªåŠ¨':'æ‰‹åŠ¨'}é¡¹`);
			window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
		}

		function delRow(index) {
			if(tableData.length <= 1) { showToast("âš ï¸ è‡³å°‘ä¿ç•™1ä¸ª"); return; }
			tableData.splice(index, 1);
			localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(tableData));
			renderCards();
		}

		function clearAllData() {
			if(!confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) return;
			tableData = [{ fan: 60, o2: 21, steamRatio: 0.3, mode: 'auto', manualAddO2: 1500, manualTotalWind: 10000, manualO2Ratio: 18.0, manualSteam: 1000, manualFanHz: 0 }];
			localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(tableData));
			renderCards();
		}
	</script>
</body>
</html>